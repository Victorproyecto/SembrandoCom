<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Huertos Cooperativas - Sembrando Comunidad</title>
    <link rel="stylesheet" href="../vista/css/styles lucia.css">
</head>
<body>

    <!-- Header cargado dinámicamente -->
    <div id="header-placeholder"></div>

    <main class="contenedor-principal">
        <!-- Columna izquierda: Crear Huerto -->
        <section class="crear-huerto">
            <h2>Crear Huerto</h2>
            <form id="form-crear-huerto" action="../controlador/crear_huerto.php" method="POST">
                <input type="text" name="nombre" placeholder="Nombre del huerto" required>
                <textarea name="direccion" placeholder="Dirección del huerto" required></textarea>
                <input type="number" name="aforo" placeholder="Aforo del huerto" required>
                
                <!-- Campos adicionales requeridos por el script PHP -->
                <input type="hidden" name="idCooperativa" value="1">

                <button type="submit" class="btn-crear">Crear Huerto</button>
            </form>
        </section>

        <!-- Columna derecha: Mis Huertos -->
        <section class="mis-huertos">
            <h2>Mis Huertos</h2>
            <!-- Los huertos serán generados dinámicamente aquí -->
        </section>
    </main>

    <!-- Modal para editar huerto -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <span id="close-modal" class="close">&times;</span>
            <h2>Editar Huerto</h2>
            <form id="form-editar-huerto">
                <input type="hidden" id="edit-id" name="id">
                <input type="text" id="edit-nombre" name="nombre" placeholder="Nombre del huerto" required>
                <textarea id="edit-direccion" name="direccion" placeholder="Dirección del huerto" required></textarea>
                <input type="number" id="edit-aforo" name="aforo" placeholder="Aforo del huerto" required>
                <button type="submit" class="btn-guardar">Guardar Cambios</button>
            </form>
        </div>
    </div>

    <!-- Footer cargado dinámicamente -->
    <div id="footer-placeholder"></div>

    <!-- Script para cargar el header y footer -->
    <script src="../vista/js/header_footer_coop.js"></script>

    <!-- Script para manejar los huertos relacionados a la cooperativa -->
    <script>
        // Función para obtener los huertos desde el controlador
        async function fetchHuertos(idCooperativa) {
            try {
                const response = await fetch(`../controlador/get_huertos.php?idCooperativa=${idCooperativa}`);
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const huertos = await response.json();
                displayHuertos(huertos);
            } catch (error) {
                console.error('Hubo un problema con la petición Fetch:', error);
            }
        }

        // Función para mostrar los huertos en la vista (sección "Mis Huertos")
        function displayHuertos(huertos) {
            const container = document.querySelector('.mis-huertos');
            container.innerHTML = ''; // Limpiar el contenedor antes de agregar nuevos huertos

            const header = document.createElement('h2');
            header.textContent = "Mis Huertos";
            container.appendChild(header);

            huertos.forEach(huerto => {
                const huertoDiv = document.createElement('div');
                huertoDiv.classList.add('huerto');
                huertoDiv.innerHTML = `
                    <h3>${huerto.nombre}</h3>
                    <p><strong>Dirección:</strong> ${huerto.direccion}</p>
                    <p><strong>Municipio ID:</strong> ${huerto.idMunicipio}</p>
                    <p><strong>Aforo:</strong> ${huerto.aforo}</p>
                    <button class="btn-editar" data-id="${huerto.id}">Editar</button>
                    <button class="btn-eliminar" data-id="${huerto.id}">Eliminar</button>
                `;
                container.appendChild(huertoDiv);
            });

            // Añadir event listeners a los botones de eliminar y editar
            const deleteButtons = document.querySelectorAll('.btn-eliminar');
            deleteButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    eliminarHuerto(id);
                });
            });

            const editButtons = document.querySelectorAll('.btn-editar');
            editButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    mostrarModalEditar(id);
                });
            });
        }
        // Función para eliminar un huerto
        async function eliminarHuerto(id) {
            if (!confirm("¿Estás seguro de que deseas eliminar este huerto?")) {
                return; // Si el usuario cancela, no se ejecuta la eliminación
            }

            try {
                const response = await fetch('../controlador/eliminar_huerto.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `id=${id}`
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const result = await response.json();

                if (result.message) {
                    alert(result.message);
                    // Recargar los huertos para reflejar los cambios
                    fetchHuertos(1); // Cambia por el idCooperativa correcto si es dinámico
                } else if (result.error) {
                    alert(result.error);
                }
            } catch (error) {
                console.error('Hubo un problema con la petición Fetch:', error);
                alert('Hubo un problema al eliminar el huerto. Por favor, intenta nuevamente.');
            }
        }

        // Mostrar modal para editar huerto
        function mostrarModalEditar(id) {
            // Obtener información del huerto para editar
            const huerto = document.querySelector(`.huerto [data-id='${id}']`).parentElement;
            document.getElementById('edit-id').value = id;
            document.getElementById('edit-nombre').value = huerto.querySelector('h3').innerText;
            document.getElementById('edit-direccion').value = huerto.querySelector('p:nth-of-type(1)').innerText.replace("Dirección: ", "");
            document.getElementById('edit-aforo').value = huerto.querySelector('p:nth-of-type(3)').innerText.replace("Aforo: ", "");

            // Mostrar el modal
            const modal = document.getElementById('edit-modal');
            modal.style.display = 'block';
        }

        // Cerrar modal
        document.getElementById('close-modal').addEventListener('click', () => {
            document.getElementById('edit-modal').style.display = 'none';
        });

        // Función para manejar la edición del huerto
        document.getElementById('form-editar-huerto').addEventListener('submit', async function (event) {
            event.preventDefault(); // Evitar recargar la página

            const id = document.getElementById('edit-id').value;
            const nombre = document.getElementById('edit-nombre').value;
            const direccion = document.getElementById('edit-direccion').value;
            const aforo = document.getElementById('edit-aforo').value;

            try {
                const response = await fetch('../controlador/editar_huerto.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `id=${id}&nombre=${nombre}&direccion=${direccion}&aforo=${aforo}`
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const result = await response.json();

                if (result.message) {
                    alert(result.message);
                    // Recargar los huertos para reflejar los cambios
                    fetchHuertos(1);
                } else if (result.error) {
                    alert(result.error);
                }
            } catch (error) {
                console.error('Hubo un problema con la petición Fetch:', error);
                alert('Hubo un problema al editar el huerto. Por favor, intenta nuevamente.');
            }

            document.getElementById('edit-modal').style.display = 'none'; // Cerrar el modal después de guardar
        });

        // Llamar a la función para obtener los huertos al cargar la página
        const idCooperativa = 1; // Esto debe ser dinámico dependiendo de la cooperativa que esté usando la página
        fetchHuertos(idCooperativa);
    </script>
</body>
</html>
